---
layout: post
title: "「网络编程」 四、Https协议"
subtitle: 'Android'
date:       2019-02-13
author: "Wangxiong"
header-style: text
tags:
  - HTTPS
  - 网络编程
---
## 1. Https简介

Http协议的风险：窃听风险：Http采用明文传输数据，第三方可以获知通信内容；篡改风险：第三方可以修改通信内容；冒充风险：第三方可以冒充他人身份进行通信。所以产生了Https协议，Https协议是以安全为目标的Http通道，简单来说就是Http的安全版。主要是在Http下加入SSL层（现在主流的是SLL/TLS），SSL是Https协议的安全基础。Https默认端口号为443。SSL/TSL解决Http协议分险的主要方式是，所有信息加密传输，三方窃听通信内容；具有校验机制，内容一旦被篡改，通信双发立刻会发现；配备身份证书，防止身份被冒充。

## 2. Https与http的区别

1. https协议需要到CA申请证书，大多数情况下需要一定费用
2. 断开变化，http默认端口是80，https默认端口是443
3. https可以有效的防止运行商劫持，解决防劫持的一个大问题.
4. Http是超文本传输协议，信息采用明文传输，Https则是具有安全性SSL加密传输协议
5. Http和Https端口号不一样，Http是80端口，Https是443端口
6. Http连接是无状态的，而Https采用Http+SSL构建可进行加密传输、身份认证的网络协议，更安全。
7. Http协议建立连接的过程比Https协议快。因为Https除了Tcp三次握手，还要经过SSL握手。连接建立之后数据传输速度，二者无明显区别。

## 3. SSL/TSL

SSL:Secure Sockets Layer 安全套接层

### 3.1 SSL发展史（互联网加密通信）

1. 1994年NetSpace公司设计SSL协议（Secure Sockets Layout）1.0版本，但未发布。
2. 1995年NetSpace发布SSL/2.0版本，很快发现有严重漏洞
3. 1996年发布SSL/3.0版本，得到大规模应用
4. 1999年，发布了SSL升级版TLS/1.0版本，目前应用最广泛的版本
5. 2006年和2008年，发布了TLS/1.1版本和TLS/1.2版本

### 3.2 SSL原理及运行过程

SSL/TLS协议基本思路是采用公钥加密法（最有名的是RSA加密算法）。大概流程是，客户端向服务器索要公钥，然后用公钥加密信息，服务器收到密文，用自己的私钥解密。为了防止公钥被篡改，把公钥放在数字证书中，证书可信则公钥可信。公钥加密计算量很大，为了提高效率，服务端和客户端都生成对话秘钥，用它加密信息，而对话秘钥是对称加密，速度非常快。而公钥用来机密对话秘钥。密钥对是一对公钥和私钥，密钥对是一起产生的 ，可以互相加密解密。对证书而言私钥由自己保存，用于签名信息。公钥发给想要通信的一端，用于验证信息是你发过来的。一般只用私钥进行签名。主要过程如下：

1. 客户端给出协议版本号、一个客户端随机数A（Client random）以及客户端支持的加密方式
2. 服务端确认双方使用的加密方式，并给出数字证书、一个服务器生成的随机数B（Server random）
3. 客户端确认数字证书有效，生成一个新的随机数C（Pre-master-secret），使用证书中的公钥对C加密，发送给服务端
4. 服务端使用自己的私钥解密出C
5. 客户端和服务器根据约定的加密方法，使用三个随机数ABC，生成对话秘钥，之后的通信都用这个对话秘钥进行加密

### 3.2 SSL证书

Https协议中需要使用到SSL证书，SSL证书是一个二进制文件，里面包含经过认证的网站公钥和一些元数据，需要从经销商购买，证书有很多类型，按认证级别分类：

- 域名认证（DV=Domain Validation）：最低级别的认证，可以确认申请人拥有这个域名
- 公司认证（OV=Organization Validation）：确认域名所有人是哪家公司，证书里面包含公司的信息
- 扩展认证（EV=Extended Validation）：最高级别认证，浏览器地址栏会显示公司名称。

EV证书浏览器地址栏样式：

![http-3.png](https://upload-images.jianshu.io/upload_images/10547376-30c56f43b054f20c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

OV证书浏览器地址栏样式：

![http-4.png](https://upload-images.jianshu.io/upload_images/10547376-baff96262133c8e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

DV证书浏览器样式：

![http-5.png](https://upload-images.jianshu.io/upload_images/10547376-6948554ac4f7fb4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 3.4 加密算法

加密算法分为对称加密、非对称加密和Hash加密算法。

- 对称加密：甲方和乙方使用同一种加密规则对信息加解密

  对称加密算法加解密效率高，速度快，适合大数据量加解密。常见的堆成加密算法有DES、AES、RC5、Blowfish、IDEA

- 非对称加密：乙方生成两把秘钥（公钥和私钥）。公钥是公开的，任何人都可以获取，私钥是保密的，只存在于乙方手中。甲方获取公钥，然后用公钥加密信息，乙方得到密文后，用私钥解密。

  非对称加密算法复杂，加解密速度慢，但安全性高，一般与对称加密结合使用（对称加密通信内容，非对称加密对称秘钥），常见的非对称加密算法有RSA、DH、DSA、ECC

- Hash加密：Hash算法是一种单向密码体制，即只有加密过程，没有解密过程

  Hash算法特性是：输入值一样，经过哈希函数得到相同的散列值，但并非散列值相同则输入值也相同。常见的Hash加密算法有MD5、SHA-1、SHA-X系列

#### 3.4.1 RSA加密算法

Https协议就是使用RSA加密算法，可以说RSA加密算法是宇宙中最重要的加密算法。
RSA算法用到一些数论知识，包括互质关系，欧拉函数，欧拉定理。此处不具体介绍加密的过程，如果有兴趣，可以参照RSA算法加密过程。*http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html*。RSA算法的安全保障基于大数分解问题，目前破解过的最大秘钥是700+位，也就代表1024位秘钥和2048位秘钥可以认为绝对安全。大数分解主要难点在于计算能力，如果未来计算能力有了质的提升，那么这些秘钥也是有可能被破解的。

#### 3.4.2 DH加密算法

DH也是一种非对称加密算法，DH加密算法过程。*https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B*DH算法的安全保障是基于离散对数问题

## 4. 证书验证

支持hppts的网站基本上都是CA机构颁发的证书，默认情况下是可以信任的。但是有一些网站的证书是自签名的，使用浏览器访问的时候会报风险警告，比如12306网站。正常访问有证书的服务端，需要进行证书的校验，对于权威机构颁发的证书当然我们会直接认为合法。对于自签名的证书，那么我们就需要去校验合法性了，也就是说我们只需要让OkhttpClient去信任这个证书就可以畅通的进行通信了。当然，对于自签名的网站的访问，网上的部分的做法是直接设置信任所有的证书，对于这种做法肯定是有风险的。

Java平台默认识别jks格式的证书文件，但是android平台只识别bks格式的证书文件。我们需要将我们的jks文件转化为bks文件。通过bcprov.jar文件将wx_client.jks文件转换为wx_client.bks文件

**配置服务端自签名的证书**

1. 可以购买证书，也可以制作自签名的证书，通过keytool生成证书。
2. 先生成一个证书请求文件wx_server.jks。
3. 再利用wx_server.jks生成包含公钥的证书wx_server.cer。
4. 将生成的jks文件配置到服务端。客户端就可以利用wx_server.cer文件进行证书校验。

**双向证书验证**

即客户端也有一对wx_client.jks文件和wx_client.cer文件。然后进行配置

1. 配置服务端信任wx_client.cer文件。再用浏览器访问就访问不到服务端了。会显示证书身份验证失败。
2. 配置客户端，利用wx_client.jks文件。进行设置

## 5. SSLSocket

SSLSocket扩展Socket并提供使用SSL或TLS协议的安全套接字，简单来说SSLSocket通信就是需要服务端和客户端进行证书验证的socket通信。

