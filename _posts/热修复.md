热修复

Total control电脑连接手机模拟器

AndFix

Tinker

javac将java编译chengclass，da.bat打包dex

classes.dex(主包5)

classes2.dex(bug包)

.....



增量更新：差分补丁

热修复：修复线上bug

插件化：拓展功能



思路：将我们修复好的classes2.dex下载到本机，并替换有bug的dex文件

1.创建BaseDexClassLoader子类DexClassLoader加载器

2.加载修复好的classes2.dex(从服务端下载好的修复包)

3.将自己的dex和系统的dexElements进行合并生成自己的dexElemnents，并且设置dexElemnents的优先级(自己的dex插到最前边)

4.通过反射技术，赋值给系统BaseDexClassLoader的pathList

新的dexElemnents：classes2.dex(修复包)、classes.dex、classes2.dex(bug包)、...



multidex配置



1.从服务端下载修复包

2.复制修复包到app的私有目录(源文件，目标目录和文件，删除之前存在的dex)

3.开始修复：

​	1.



过程：请求接口下载修复的dex文件，如3.3版本请求接口，发下有修复故障的dex文件，则下载

```java
class BaseDexClassLoader extends ClassLoader {
    private final DexPathList pathList;
    
    //...
    
    
    findClass() {
        pathList.findClass()
    }
}
```





```java
class DexPathList  {
    Element[] dexElements;//classes.dex, classes2.dex，...
}
```



注意事项：

1.主包classes.dex不能有bug

2.必须是运行

类加载器：ClassLoader

子类：BaseDexClassLoader



一般下载的apk放在sdcard/download目录下

app安装成功，同时复制一份apk文件到私有目录：data/app/packageName-1/base.apk