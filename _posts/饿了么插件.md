# 饿了么的插件简单介绍

饿了么的仓库地址：<http://maven.dev.elenet.me/nexus/content/groups/public/me/ele/eradle/>

可以用阿里镜像代替，如下

```groovy
maven { url 'http://aone-nexus.alibaba-inc.com/nexus/content/repositories/eleme-public' }
maven { url 'http://aone-nexus.alibaba-inc.com/nexus/content/repositories/eleme-snapshots' }
```

## 一、eradle（上传仓库）、encryptAar插件（生成物加固）

### 1.eradle插件

- 下载配置：classpath 'me.ele:eradle:1.7.0'

- 功能简介：定义了如下modifyPom方法，可以上传到饿了么的maven仓库，需要在local.properties中配置用户名和密码参数nexusUsername, nexusPassword

- 插件入口主类：EradlePlugin

  ```groovy
  EradlePlugin{
      project.plugins.apply(NexusPlugin)
  	project.plugins.apply(AttachSourcesPlugin)
  }
  
  NexusPlugin	{
      //主要应用了如下三个Plugin和一个自定义属性
      project.plugins.apply(ExtraArchivePlugin) 
      project.plugins.apply(MavenPlugin)    //应用maven仓库的插件
      project.plugins.apply(SigningPlugin)  //应用Gradle的签名插件
      NexusPluginExtension extension = project.extensions.create('nexus', NexusPluginExtension
      //自定义的ExtraArchivePlugin中新建了一个Jar类类型的Task
      //NexusPluginExtension定义了一些签名和仓库的配置。
      //定义了modifyPom方法，用于执行upload的uploadArchives上传代码到饿了么Maven仓库
  }
  AttachSourcesPlugin 自定义了一个attachSources Task
  ```

- 插件使用：

  1.apply plugin: 'eradle'

  2.定义modifyPom

  ```groovy
  modifyPom {
      project {
          groupId 'me.ele'
          artifactId 'eradle'
          version '2.0.1-SNAPSHOT'
          packaging 'jar'
      }
  }
  ```

### 2.encryptAar插件（暂时未用的）

- 下载配置：classpath 'me.ele:eradle:1.7.0'

- 插件使用： apply plugin: 'encryptAar'

- 插件入口主类EncryptPlugin 

- 功能简介：

  1.类内自定义了属性encryptAar（EncryptPluginExtension）

```java
Boolean enable = Boolean.FALSE
File sourceAarFile
File targetAarFile
String javaEntry
String soName
String classPath
```

## 二、exlude插件

* 下载配置：classpath “me.ele:registry-central-plugin:2.0.0.14-SNAPSHOT”

* 插件入口主类：ExcludePlugin

* 功能简介：

  1.读取include-standard.json，获取所有支持插桩的业务和模块，2.读取include-custom.json，获取需要注释的模块，3.通过1和2生成excludes.json,存于app/build/intermediates/excludes.json。


```groovy
ExcludePlugin {
	private List<String> businessExclude
    private List<String> componentExclude
    private List<String> baseExclude
    ....
    excludeAppModules() {
        //第一步
        String modularStandardContent = Util.readFile(project.file('include-standard.json').absolutePath)
        ....
        //第二步
        String modularCustomContent = Util.readFile(project.file('include-custom.json').absolutePath)
    }
   		.....
    	//第三步
    	File file = new File(project.file('build/intermediates'), 'excludes.json')
}

```

## 二、registry-central插件（注册）

- 下载配置：classpath “me.ele:registry-central-plugin:2.0.0.14-SNAPSHOT”

- 功能简介：1.读取excludes.json，2.读取 app/registry-central.json，3根据1和2提出相关类，4.在enable为true时，遍历input，找到annotations集合内的注解，5.扫描annotations的列表，6.注册到RegistryCentral类内。

- 插件入口主类：RegistryCentralPlugin

  ```groovy
  RegistryCentralPlugin{
      //定义RegistryCentralExtension属性
      create('registryCentral', RegistryCentralExtension.class)
      //注册了自定义的Transform监听
      getByType(AppExtension.class).registerTransform(new RegistryCentralTransform(project))
  }
  ```

  ```groovy
  RegistryCentralExtension {
      @PackageScope
      boolean enable = false
      @PackageScope
      List<String> annotations = []
  }
  
  ```

  ```groovy
  RegistryCentralTransform {
      private static final String REGISTRY_MODULE_NAME = 'me.ele.rc.RegistryModule'
      private static final String REGISTRY_MODULE_ALIAS_NAME = 'me.ele.rc.RegistryModuleAlias'
      public static final String JSON_FILE_NAME = 'registry_central.json'
      
      transform() {
          //第一步读取excludes.json
          String excludesContent = Util.readFile(project.file('build/intermediates/excludes.json').absolutePath)
          ....
          //第二步读取 app/registry-central.json
          String rcContent = Util.readFile(project.file('registry-central.json').absolutePath)
          ....
          ///第三步
          initInputs(transformInvocation, inputFiles)
          //第四部：
           def configFile = new File(                       "${variant.mergeAssets.outputDir.getAbsolutePath()}/${JSON_FILE_NAME}")
      }
  }
  ```

- 插件使用：

  apply plugin: 'me.ele.registry-central'

  定义registryCentral参数

  registryCentral {

  ​	 enable true

  ​	 annotations 'me.ele.router.Route', 'me.ele.router.RouteModel', 'me.ele.epreloader.Loader', 	'com.orhanobut.hawk.annotation.Key', 'me.ele.omniknight.annotation.Implementation'

  }

## 三、RegistryCenter Library（注册中心）

此工程定义了三个注解Nulll RegistryModule RegistryModuleAlias三个注解以及注册中心类RegistryCentral

1. 这个是一个Library工程不是插件，与registry-central插件要区分开。

2. 使用方法：implementation 'me.ele:registry-central:2.1.4’ 

3. RegistryCentral：

   主要功能：

   (1) 两个集合valuesMap，classMapCache存储了注册了的模块信息​	

   (2) 读取Assets目录下的registry_central.json文件生成map集合

   (3) 注册后通过读取map集合获取对应的模块类名

## 四、modular插件（模块化插件）

- 下载配置：classpath 'me.ele:modular:1.8.6'

- 功能简介：1.自定义了moduleImplementation依赖，用于依赖业务模块，2读取module_version.json文件，3.监听依赖，检查使用moduleImplementation依赖的模块，用本地依赖替换远程依赖。

- 插件入口主类：ModularPlugin

  ```groovy
  ModularPlugin{
      target.extensions.create(ModularExtension.NAME, ModularExtension) //空的暂时未用到
       // 定义了两个Task uploadDebugModule,uploadReleaseModule，仓库信息等，上传模块
      target.plugins.apply(NexusPlugin)
      target.plugins.apply(ModulePlugin)
  }
  ```

  ```groovy
  ModulePlugin{
      //1.自定义了configurations moduleImplementation继承implementation
      moduleImplementation = project.configurations.create('moduleImplementation')
      implementation.extendsFrom moduleImplementation
      ...
  	//2.读取module_version.json文件生成map集合（各模块远程仓库）
      def jsonFile = new File("$project.rootProject.rootDir.absolutePath/module_version.json")
      ...
  	//3.通过监听依赖DependencyResolutionListener，在确定依赖关系前，查找本地是否有此模块，有就剔除远程库，没有就依赖远程的
      project.gradle.addListener(new DependencyResolutionListener() {
          processDependenciesConfig(it)
      }
  }
  ```

- 使用

  apply plugin: 'modular'

## 五、Router路由

- 代码地址：http://gitlab.alibaba-inc.com/eleme-android/DroidRouter

- 三个主要的注解：

  * @Route 定义路由规则，目前可以定义在Activity及IRoute的实现类上

  - @Required 用来限定scheme中的参数的数据类型，定义请参考下表, 其中在参数类型后接 **+** 表示该参数为必传的非空参数
  - @RouteModel 定义route中的自定义model, 别名用于指定下表的format(参考了Intent.ParseUri())

- 主要功能：用于页面界的跳转。核心是通过读取RegistryCentral中的map，找到跳转的类，然后执行

```java
public static Class findRouteClass(Scheme scheme) {
  return RegistryCentral.map(MODULE_ROUTER).get(scheme.identifier());
}
```

## 六、omniknight

omniknight是 基于dagger2开发的依赖注入库。

* 主要功能：模块间的调用